#PRACTICE 2: IMPORT ADDRESS LIST TO DATABASE

Given a csv file which represents a contacts list (name, email and phone), we will create a job _ImportAddressListJob_ 
to import all contacts to a relational database.

To do it, we will go through 12 tasks that are the following:

1. Set up build environment
1. Set up spring batch infrastructure and application
1. Set up database environment
1. Set up import environment
1. Create `Contact` object
1. Define job
1. Define import step
1. Define the [ItemReader][BATCH-ITEM-READER]
1. Define the [ItemProcessor][BATCH-ITEM-PROCESSOR]
1. Define the [ItemWriter][BATCH-ITEM-WRITER]
1. Define verify step
1. Build, run & enjoy

In spring batch, each job is a sequence of steps (see: [Configuring and Running a Job](https://docs.spring.io/spring-batch/reference/html/configureJob.html)); steps come in two flavours: tasklet oriented and chunk oriented (see: [Configuring Step](https://docs.spring.io/spring-batch/reference/html/configureStep.html)).

In this practice we will create a job _ImportAddressListJob_ with two steps: _ImportAddressListStep_ that is a chunk-oriented one and _VerifyStep_ which is a tasklet step (it will be used to verify that everything went well). We will create an [ItemReader][BATCH-ITEM-READER], an [ItemProcessor][BATCH-ITEM-PROCESSOR] and an [ItemWriter][BATCH-ITEM-WRITER] to do the job of importing a CSV file to a database.

<strong>Note:</strong> Most of this practice is based on [https://spring.io/guides/gs/batch-processing/](https://spring.io/guides/gs/batch-processing/) although it is not identical.

## TASK 1: SET UP BUILD ENVIRONMENT

Since we already practiced this in [exercise 1][EXERCISE-1], you only need to follow two quick steps:

1. Create the gradle files using the content provided in the links
1. Create the directories used by gradle

Details:

1. Create the gradle files using the content provided in the links (both in the root of exercise-2 project)

    1. [build.gradle][FILE-BUILD-GRADLE]: this is slightly different from the [exercise 1][EXERCISE-1] since we are also importing database dependencies
    1. [gradle.properties][FILE-GRADLE-PROPERTIES]: this is the same as in [exercise 1][EXERCISE-1]
    
    <strong>Remarks: </strong> By adding a database dependency, spring boot will create a pre-configured datasource spring bean, for the case of HSQLDB (among others), the database will reside in memory and it won't have a password. See more: [Spring Boot Database Initialization][SPRING-BOOT-DATABASE-INITIALIZATION].
    
1. Create the directories used by gradle

    If you are in a bash terminal, you can create all of them with the following command:

    ```sh
    shell$ mkdir -pv src/{main,test}/{java/resources}
    ```

    The following directories must exist:

    ```
    src/main/java
    src/main/resources
    src/test/java
    src/test/resources
    ```
    
##TASK 2: SET UP SPRING BATCH INFRASTRUCTURE AND APPLICATION

We will quickly create the necessary classes to have both, our application and spring batch infrastructure beans.

So, you need to follow two steps: (see [exercise 1][EXERCISE-1] if you want more context)

1. Create the application main entry point
1. Create spring batch infrastructure

Details:

1. Create the application main entry point

    Just create a class named `Application` in `src/main/java/importaddresslist` with the following contents:
    
    ```java
    package importaddresslist;

    import org.springframework.boot.SpringApplication;
    import org.springframework.boot.autoconfigure.SpringBootApplication;

    @SpringBootApplication
    public class Application {
        public static void main(String... args) {
            SpringApplication.run(Application.class, args);
        }
    }
    ```

1. Create spring batch infrastructure

    Just create a class named `BatchConfiguration` in `src/main/java/importaddresslist` with the following contents:
        
    ```java
    package importaddresslist;

    import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
    import org.springframework.context.annotation.Configuration;

    @Configuration
    @EnableBatchProcessing
    public class BatchConfiguration {
    }
    ```

##TASK 3: SET UP DATABASE ENVIRONMENT

You only need to create the following script in `src/main/resources/schema.sql`:

```sql
CREATE TABLE contacts (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY (START WITH 1) PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(75),
    phone VARCHAR(20)
);
```

<strong>Rationale: </strong> Spring boot will do the following two tasks for you: a) It will create a DataSource bean in spring, b) It will execute your script in your configured database. See more: [Spring Boot Database Initialization][SPRING-BOOT-DATABASE-INITIALIZATION]

##TASK 4: SET UP IMPORT ENVIRONMENT

You need to define where will the input fille be processed, and also we need the file itself, for this exercise, we will use the classpath, although in production environments, either fixed absolute paths are best or based on configurations/parameters.

Create a file named `contacts.csv` at `src/main/resources/` with the following contents:

```csv
name,email,phone
my name 1,name1@email.com,111-111-1111
my name 2,name2@email.com,222-222-2222
my name 3,name3@email.com,333-333-3333
```

##TASK 5: CREATE `Contact` OBJECT

You will use a POJO to store per-row information about the contacts to import to database:

```java
package importaddresslist;

public class Contact {
    private String name;
    private String email;
    private String phone;

    // getters & setters & toString/equals/hashCode
}

```

##TASK 6: DEFINE JOB

As in [Exercise 1][EXERCISE-1], just create a method to define the job bean inside `importaddresslist.BatchConfiguration` class:

```java
@Configuration
@EnableBatchProcessing
public class BatchConfiguration {

    @Bean
    public Job helloWorldJob(JobBuilderFactory jobs, Step importAddressListStep) {
        return jobs.get("ImportAddressListJob") //
                .incrementer(new RunIdIncrementer()) //
                .start(importAddressListStep)
                .build();
    }
    
}
```

##TASK 7: DEFINE IMPORT STEP

Add the following method to the `BatchConfiguration` class:

```java
// package declaration
// several imports

@Configuration
@EnableBatchProcessing
public class BatchConfiguration {

    // helloWorldJob() {...}

    @Bean
    public Step importAddressListStep(
            StepBuilderFactory steps,
            ItemReader<Contact> reader,
            ItemProcessor<Contact, Contact> processor,
            ItemWriter<Contact> writer) //
    {
        return steps.get("ImportAddressListStep") //
                .<Contact, Contact>chunk(10) // process items in groups of 10
                .reader(reader)
                .processor(processor)
                .writer(writer)
                .build();
    }
    
}
```

<strong>Remarks:</strong> `chunk` method needs to be parameterized in order to avoid compiler errors.

##TASK 8: DEFINE THE [ItemReader][BATCH-ITEM-READER]

Create a method to instantiate the reader:

```java
// package declaration
// several imports

@Configuration
@EnableBatchProcessing
public class BatchConfiguration {

    // helloWorldJob() {...}

    // importAddressListStep() {...}

    @Bean
    public ItemReader<Contact> reader() {
        FlatFileItemReader<Contact> reader = new FlatFileItemReader<>();
        
        reader.setResource(new ClassPathResource("contacts.csv"));
        reader.setLinesToSkip(1); // we will skip column names row
        
        reader.setLineMapper(new DefaultLineMapper<Contact>() {{
            setLineTokenizer(new DelimitedLineTokenizer() {{
                setNames(new String[]{"name", "email", "phone"});
            }});
            
            setFieldSetMapper(new BeanWrapperFieldSetMapper<Contact>(){{
                setTargetType(Contact.class);
            }});
        }});
        
        return reader;
    }

}
```

<strong>Rationale:</strong> Here are many things that need an explanation, although the names & javadoc are an excellent source of understanding.

##TASK 9: DEFINE THE [ItemProcessor][BATCH-ITEM-PROCESSOR]

For this moment, we only will use our own implementation of [PassThroughItemProcessor](https://docs.spring.io/spring-batch/apidocs/org/springframework/batch/item/support/PassThroughItemProcessor.html) which actually doesn't do anything except passing the object to the writer.

Feel free to add some custom code such as logging, changing case, etc.

```java
// package declaration
// several imports

@Configuration
@EnableBatchProcessing
public class BatchConfiguration {

    // helloWorldJob() {...}

    // importAddressListStep() {...}

    // reader() {...}
    
    @Bean
    public ItemProcessor<Contact, Contact> processor() {
        return item -> item;
    }

}
```

##TASK 10: DEFINE THE [ItemWriter][BATCH-ITEM-WRITER]

Add a method to instantiate the `ItemWriter` object configured to write to database:

```java
// package declaration
// several imports

@Configuration
@EnableBatchProcessing
public class BatchConfiguration {

    // helloWorldJob() {...}

    // importAddressListStep() {...}

    // reader() {...}
    
    // processor() {...}
    
    @Bean
    public ItemWriter<Contact> writer(DataSource dataSource) { // spring boot automatically will create dataSource bean
        JdbcBatchItemWriter<Contact> writer = new JdbcBatchItemWriter<>();
        
        writer.setItemSqlParameterSourceProvider(new BeanPropertyItemSqlParameterSourceProvider<>());
        writer.setSql("INSERT INTO contacts (name, email, phone) VALUES (:name, :email, :phone)");
        writer.setDataSource(dataSource);
        
        return writer;
    }

}
```

<strong>Remarks: </strong> It is worth to check javadoc for each created class. Also, spring boot will automatically create a bean `dataSource` and autowire whenever it is required. See: [Spring Boot Database Initialization][SPRING-BOOT-DATABASE-INITIALIZATION]

##TASK 11: DEFINE VERIFY STEP

The final step of the job will add a step (_VerifyImportStep_) to verify that the content was correctly imported through executing a SQL query and dump the results.
 
You need to follow the next 3 steps:

1. Update job definition with the new expected step
1. Create the new step
1. Qualify steps to allow spring differentiate them

### Details:

1. Update job definition with the new expected step

    ```java
    // package declaration
    // several imports
    
    @Configuration
    @EnableBatchProcessing
    public class BatchConfiguration {
    
        @Bean
        public Job helloWorldJob(JobBuilderFactory jobs, Step importAddressListStep, Step verifyImportStep) {
            return jobs.get("ImportAddressListJob") //
                    .incrementer(new RunIdIncrementer()) //
                    .start(importAddressListStep) //
                    .next(verifyImportStep) //
                    .build();
        }
    
        // importAddressListStep() {...}
    
        // reader() {...}
        
        // processor() {...}
        
        // writer() {...}
    
    }
    ```
    
    We are introducing two changes to `helloWorldJob` method:
    
    1. We are adding a new `verifyImportStep` parameter
    1. We are adding that step as `next` step
    
1. Create the new step

    ```java
    ```
    
    <strong>Remarks:</strong> This step is mainly based on: spring boot's [Accessing Relational Data using JDBC with Spring](https://spring.io/guides/gs/relational-data-access/).


1. Qualify steps to allow spring differentiate them

    ```java
    ```

##TASK 12: BUILD, RUN & ENJOY

<!-- global links -->

[FILE-BUILD-GRADLE]: https://github.com/rvazquezglez/spring-batch-workshop/blob/master/exercise-2/build.gradle
[FILE-GRADLE-PROPERTIES]: https://github.com/rvazquezglez/spring-batch-workshop/blob/master/exercise-2/gradle.properties
<!--[FILE-BATCH-INFRASTRUCTURE]: -->
[BATCH-ITEM-READER]: https://docs.spring.io/spring-batch/apidocs/org/springframework/batch/item/ItemReader.html
[BATCH-ITEM-PROCESSOR]: https://docs.spring.io/spring-batch/apidocs/org/springframework/batch/item/ItemProcessor.html
[BATCH-ITEM-WRITER]: https://docs.spring.io/spring-batch/apidocs/org/springframework/batch/item/ItemWriter.html
[EXERCISE-1]: https://github.com/rvazquezglez/spring-batch-workshop/tree/master/exercise-1/README.md
[SPRING-BOOT-DATABASE-INITIALIZATION]: https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html
